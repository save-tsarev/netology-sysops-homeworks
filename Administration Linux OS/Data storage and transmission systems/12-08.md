# Домашнее задание к занятию «Резервное копирование баз данных»

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение 1.

#### 1.1. Полное восстановление данных за предыдущий день

Для данного сценария подходит **инкрементное резервное копирование** в сочетании с ежедневным полным бэкапом. 

- **Решение:**
  - Каждый день выполняется полный бэкап базы данных (на ночь или в низконагруженное время).
  - В течение дня создаются инкрементные копии, которые содержат только изменения с момента последнего полного бэкапа.
  - Хранение полного бэкапа и инкрементных копий позволяет восстановить базу данных до состояния на конец предыдущего дня.

- **Преимущества:**
  - Позволяет быстро восстановить данные за предыдущий день.
  - Экономит место за счёт хранения инкрементных данных.
  - Простота реализации через встроенные средства реляционных СУБД, таких как PostgreSQL (`pg_dump`) или MySQL (`mysqldump`).

---

#### 1.2. Восстановление данных за час до поломки

Для восстановления данных с точностью до часа применяется **журналирование транзакций (WAL logs)** в сочетании с периодическим резервным копированием.

- **Решение:**
  - Включить режим постоянного архивирования журналов транзакций (WAL).
  - Периодически (например, раз в сутки) выполнять полный бэкап базы данных.
  - При восстановлении:
    - Восстановить базу данных из последнего полного бэкапа.
    - Применить журналы транзакций (WAL) до момента за час до поломки.

- **Преимущества:**
  - Высокая точность восстановления данных.
  - Возможность гибкой настройки точности восстановления, например, до минуты.
  - Широко поддерживается современными реляционными СУБД.

---

#### 1.3.* Моментальное переключение на работающую базу данных при поломке

Для этого кейса используется **кластеризация и репликация данных**.

- **Решение:**
  - Настроить мастер-слейв или мастер-мастер репликацию.
  - Использовать инструменты автоматического переключения (фейловера), такие как:
    - **Patroni** (для PostgreSQL),
    - **MySQL Group Replication**,
    - **Microsoft SQL Always On**.
  - В случае поломки мастер-узла автоматически переключаться на слейв.

- **Пример реализации:**
  - Настройка нескольких узлов базы данных с активной синхронной репликацией.
  - Использование системы управления кластерами, например, **Pacemaker** или **Kubernetes**, для мониторинга состояния и переключения.

- **Преимущества:**
  - Минимальное время простоя при поломке.
  - Отсутствие потерь данных при синхронной репликации.
  - Высокая доступность системы.
---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение 2.

#### 2.1. Пример команды резервирования данных и восстановления БД (pg_dump/pg_restore)

##### Резервное копирование базы данных

Для создания резервной копии базы данных с использованием утилиты `pg_dump`:

```bash
pg_dump -U postgres -d my_database -F c -f /path/to/backup_file.dump
```
Описание параметров:
-U postgres — имя пользователя для подключения к PostgreSQL.
-d my_database — имя базы данных для резервного копирования.
-F c — формат резервной копии (c — custom format), который удобен для восстановления с помощью pg_restore.
-f /path/to/backup_file.dump — путь и имя файла для сохранения резервной копии.


Восстановление базы данных

Для восстановления базы данных из созданного файла используйте утилиту pg_restore:
```bash
pg_restore -U postgres -d restored_database -C /path/to/backup_file.dump
```

Описание параметров:
-U postgres — имя пользователя для подключения.
-d restored_database — имя целевой базы данных.
-C — указывает на создание базы данных перед восстановлением.
/path/to/backup_file.dump — путь к файлу резервной копии.

2.1.* Возможна ли автоматизация?

Да, процесс резервирования и восстановления можно автоматизировать с помощью скриптов и планировщиков задач. Вот как это можно реализовать:

Автоматизация резервного копирования

Используйте скрипт на Bash и планировщик задач (например, cron).

Скрипт резервного копирования (backup.sh):
```bash
#!/bin/bash

# Переменные
DB_USER="postgres"
DB_NAME="my_database"
BACKUP_PATH="/path/to/backups"
DATE=$(date +%Y-%m-%d)

# Создание резервной копии
pg_dump -U $DB_USER -d $DB_NAME -F c -f $BACKUP_PATH/backup_$DATE.dump

# Очистка старых резервных копий (старше 7 дней)
find $BACKUP_PATH -type f -name "*.dump" -mtime +7 -exec rm {} \;
```

Настройка cron для автоматического выполнения:

1.	Откроем файл конфигурации cron:

crontab -e

2.	Добавим строку для ежедневного выполнения скрипта:

0 2 * * * /path/to/backup.sh

Автоматизация восстановления

Для восстановления базы данных можно также написать скрипт:

Скрипт восстановления (restore.sh):
```bash
#!/bin/bash

# Переменные
DB_USER="postgres"
DB_NAME="restored_database"
BACKUP_FILE="/path/to/backups/backup_latest.dump"

# Восстановление базы данных
pg_restore -U $DB_USER -d $DB_NAME -C $BACKUP_FILE
```
Этот процесс можно запускать вручную или автоматизировать через планировщик задач.

Преимущества автоматизации:

1.	Снижение человеческого фактора.
2.	Регулярное выполнение резервного копирования.
3.	Удаление устаревших резервных копий для экономии дискового пространства.
4.	Упрощение восстановления в случае сбоя.


---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение 3.

#### 3.1. Пример команды инкрементного резервного копирования MySQL

Для выполнения инкрементного резервного копирования в MySQL используется утилита `mysqlbackup`, которая входит в пакет MySQL Enterprise Backup. Пример команды:

```bash
mysqlbackup --backup-dir=/path/to/backup/ --incremental --incremental-base=history:last_backup backup
```

Описание параметров:
--backup-dir=/path/to/backup/ — директория, куда сохраняется инкрементная копия.
--incremental — указывает, что выполняется инкрементное резервное копирование.
--incremental-base=history:last_backup — использует последнюю завершенную резервную копию как основу для инкрементного бэкапа.
backup — основная команда для создания резервной копии.

Восстановление из инкрементной копии:

1.Восстановим полную резервную копию:

mysqlbackup --backup-dir=/path/to/full_backup_dir copy-back

2.Применим инкрементные изменения:

mysqlbackup --incremental-backup-dir=/path/to/incremental_backup_dir apply-incremental-backup

#### 3.1.* Преимущества реплики по сравнению с обычным резервным копированием

Что такое репликация?

Репликация в MySQL — это процесс копирования данных с основного сервера (мастера) на один или несколько серверов-реплик (слейвов).

Преимущества репликации:

1.	Минимальное время простоя:
•	Репликация обеспечивает горячую копию базы данных, которая всегда синхронизирована. Это позволяет быстро переключиться на реплику при сбое основного сервера.
2.	Снижение нагрузки на основной сервер:
•	Запросы на чтение могут направляться на реплики, что разгружает основной сервер.
3.	Резервирование в режиме реального времени:
•	Реплики обновляются по мере внесения изменений на основном сервере, обеспечивая актуальные данные.
4.	Географическое распределение данных:
•	Реплики могут быть развернуты в разных регионах для повышения доступности и производительности.
5.	Гибкость восстановления:
•	Реплика позволяет восстановить данные на конкретный момент времени, что недоступно при использовании только бэкапов.
6.	Скорость восстановления:
•	Переключение на реплику (failover) происходит быстрее, чем восстановление данных из резервной копии.

Когда реплика предпочтительнее?

-Высокая доступность: Если бизнес-критично минимизировать простой базы данных.
-Снижение нагрузки: Если требуется разгрузить основной сервер за счет переноса операций чтения на реплику.
-Резервирование в реальном времени: Когда данные обновляются с минимальной задержкой.
-Распределенные системы: Если пользователи или приложения распределены географически, реплики позволяют ускорить доступ к данным.

Ограничения репликации:

-Репликация защищает только от сбоев основного сервера, но не от логических ошибок (например, удаление данных на мастере также отразится на репликах).
-Для обеспечения безопасности репликацию часто используют в сочетании с регулярным резервным копированием.